class Lab < ApplicationRecord
  SOURCES = ["WHOLE BLOOD-VENOUS", "URINE", "WHOLE BLOOD-ARTERIAL", "URINE, RANDOM", "BLOOD", "NASOPHARYNX, SWAB", "URINE 24-HOUR", "CEREBROSPINAL FLUID (CSF)", "BLOOD CULTURE, VENIPUNCTURE", "STOOL", "PERIANAL, SWAB", "BODY FLUID", "BLD PO", "SEE ORDER", "NASAL, SWAB", "URINE, CLEAN CATCH", "CERVIX ", "BRONCHUS, ALVEOLAR LAVAGE (BAL)", "NASAL", "BLOOD CULTURE, CATHETER", "NASAL, ASPIRATE", "SPUTUM", "BLOOD, CORD", "ASCITES FLUID", "THROAT", "PLEURA, FLUID", "VAGINA", "THINPREP", "URINE, CATH", "VAGINAL/RECTAL SWAB", "ABDOMINAL FLUID", "NASOPHARYNX, ASPIRATE", "WOUND", "ABSCESS", "NASAL/AXILLA/PERIRECTAL", "JOINT FLUID", "ENDOTRACHEAL ASPIRATE (ET)", "WHOLE BLOOD-CAPILLARY", "SOFT TISSUE, EXCISION", "TRACHEA, ASPIRATE", "URINE, FOLEY", "VENTRIC FLUID", "SKIN, OTHER", "TISSUE", "BLD AN", "PERITONEAL DIALYSIS FLUID", "SOFT TISSUE, BIOPSY", "SYNOVIAL FLUID", "SWAB", "OTHER", "SOFT TISSUE, DEBRIDEMENT", "BONE MARROW", "PERITONEUM, FLUID", "CORNEA, SCRAPING", "NASAL, WASH", "EXUDATE", "VAGINAL", "WHOLE BLOOD-MIX VENOUS", "CERVICAL", "BIOPSY", "BRONCHUS, ASPIRATE", "STONE", "MINIBAL", "SWEAT", "SINUS, SWAB", "PERICARDIUM, FLUID", "RECTUM, SWAB", "SHUNT", "BRONCHIAL ALVEOLAR LAVAGE QUANTITATIVE", "CORNEA", "EAR", "ASPIRATE", "BONE, BIOPSY", "TISSUE QUANTITATIVE", "SKIN, SCRAPING", "SINUS", "NASOPHARYNX, WASHING", "SKIN, BIOPSY", "DRAINAGE", "BRONCH WASH", "EYE", "URINE, NEPHROSTOMY", "DEVICE", "VESICLE", "PANCREAS, FLUID", "BREAST, FLUID", "URINE, SUPRAPUBIC CATHETER", "PERIPHEAL BLOOD STEM CELLS", "URINE, IN/OUT CATHETER", "CATHETER", "PELVIC, FLUID", "TRACHEA, TRANS-TRACHEAL ASPIRATE", "AMNIOTIC FLUID", "BONE, FRAGMENTS", "CATH TIP", "BLISTER", "GASTRIC FLUID", "AXILLA", "STERILE BODY FLUID QUANTITATIVE", "LUNG, FNA", "CYST, FLUID", "AQUEOUS", "BONE", "URETHRA, SWAB", "MANDIBLE", "SYNOVIUM", "LUNG, CORE BIOPSY", "URINE, ILEAL CONDUIT", "LYMPH NODE, BIOPSY", "BONE, CURETTAGE", "BILE", "BONE, RESECTION", "LESION", "SALIVARY GLAND", "CYST", "EYE, FLUID", "URINARY BLADDER, WASHING", "VULVA", "NASAL/GROIN", "LUNG, RESECTION", "ESOPHAGUS, BRUSHING", "NASOPHARYNX", "LYMPH NODE, FNA", "PACE WIRE", "CORNEA, DONOR", "SERUM", "PACE POCKET", "PLEURA, BIOPSY", "BRONCHUS, BIOPSY", "LUNG, WEDGE BIOPSY", "SPUTUM INDUCED", "NASOTRACHEAL", "LIVER, FLUID", "URINE, SUPRAPUBIC ASPIRATE", "SKIN", "TOE(S), AMPUTATION", "LYMPH NODE", "DRIVELINE EXIT SITE", "CONJUNCTIVA, SWAB", "SCRAPING", "NAIL CLIPPINGS", "JOINT, RESECTION", "NASAL, CAVITY", "PENIS", "HEART, VALVE", "KNEE, RESECTION", "CATH SITE", "HEMATOMA", "SKIN, DEBRIDEMENT", "SINUS, CONTENTS", "FINE NEEDLE ASPIRATE", "VITREOUS", "PUSTULE", "MUCOSA, OTHER", "SOFT TISSUE, FNA", "HAIR", "SKIN, CYST", "RECTAL", "ISLET CELLS (FINAL PREP)", "BLD FAN", "URINE, CYSTOSTOMY", "ULCER", "FISTULA", "PLEURA, RESECTION", "INCISION", "PERINEAL", "RETROPERITONEUM, FLUID", "FINGER(S), AMPUTATION", "CELLULITIS", "PENIS, SWAB", "GENITAL", "VAGINA, MUCOSA", "GALLBLADDER", "BRAIN, BIOPSY", "PLACENTA", "MIDDLE EAR CONTENTS", "SINUS, MUCOSA, BIOPSY", "COLON, BIOPSY", "ANAL", "EYELID", "ABDOMINAL WALL, BIOPSY", "BOIL", "SALIVA", "PANCREAS, BIOPSY", "MULTI-LUMEN CATHETER", "ORBIT", "PERICARDIUM, BIOPSY", "SKIN, EXCISION", "SOFT TISSUE, SCAR", "BURSA, CYST", "GRAFT", "LIVER, CORE BIOPSY", "DEBRIDEMENT, OTHER THAN SKIN", "BRONCHUS, BRUSHING", "ANEURYSM, ARTERY", "KIDNEY, FNA", "DECUBITUS", "DIALYSATE", "CYST, OTHER", "SITE", "BREAST, BIOPSY - EXCISIONAL", "SKIN, SCAR", "MASS", "HEART, BIOPSY", "NAIL", "ORAL, CYST", "LIVER, FNA", "AORTA", "FLUID", "PERICARDIUM, RESECTION", "PACEMAKER", "BRAIN, RESECTION", "PROSTATE, FLUID", "NECK, RADICAL RESECTION", "MEDIASTINUM, BIOPSY", "LUNG, TRANSBRONCHIAL BIOPSY", "ADIPOSE TISSUE", "SINUS, PARANASAL, BIOPSY", "HIP, RESECTION", "MAXILLA", "BARTHOLIN'S GLAND CYST", "NAIL TOE", "ABDOMINAL WALL, FNA", "PARACENTESIS FLUID", "PILONIDAL CYST", "NASAL, SEPTUM", "TONSIL, BIOPSY", "SPINAL CORD, BIOPSY", "ETHMOID TISSUE", "HEART, EXPLANT", "ADENOIDS", "INTERVERTEBRAL DISC", "BONE MARROW, ASPIRATE", "PALATE", "ESOPHAGUS, BIOPSY", "LYMPH NODE, REGIONAL RESECTION", "PELVIC, FNA", "PAROTID GLAND, BIOPSY", "NAIL FINGER", "VULVA, BIOPSY", "BLD PN", "TENDON", "ENDOMETRIUM, ASPIRATE", "LARYNX, BIOPSY", "SECRETION", "TRIPLE LUMEN", "SURGICAL MARGIN, NOS", "NARES", "KIDNEY, CYST", "SINUS, CURETTAGE", "SUBCUTANEOUS, FNA", "JOINT", "FALLOPIAN TUBE, CYST", "KIDNEY, NEPHRECTOMY", "HEMANGIOMA, SOFT TISSUE", "VOCAL CORD, BIOPSY", "CHEST TUBE", "UTERUS +/- TUBES/OVARIES", "ORAL CAVITY, BIOPSY", "TURBINATE", "BREAST MILK", "BREAST, IMPLANT CAPSULE", "CERVIX DEACTIVATED", "GALLBLADDER, FNA", "STOMA", "ARTERY SEGMENT", "STOMACH, BIOPSY", "JOINT, LOOSE BODY", "DUODENUM, BIOPSY", "CARDIAC VALVE", "THORACENTESIS FLUID", "PINWORM PADDLE", "HERNIA", "VALVE", "TONGUE, BIOPSY", "THYROGLOSSAL DUCT CYST", "ANUS, FISSURE", "PANCREAS, PARTIAL RESECTION", "MEDIASTINUM, FNA", "CERVIX/ENDOCERVIX", "BONE MARROW, BIOPSY", "SKIN, REPAIR", "BONE, EXOSTOSIS", "KIDNEY, WASHING", "FETAL TISSUE", "NODE", "VAGINA/CERVIX", "FOLLICLE", "COMMON BILE DUCT", "LACERATION", "LIVER, WEDGE BIOPSY", "SUBDURAL HEMATOMA", "THROMBUS", "CORDIS CATHETER", "NODULE", "SMALL BOWEL, OSTOMY", "GASTRIC ASPIRATE", "SPINAL CORD, EXCISION", "CONTACT LENS", "KIDNEY, BIOPSY", "LUNG ASPIRATE", "TENDON SHEATH", "ENDOURETHRAL", "SINUS, CYST", "LUNG, BLEB", "ORAL CAVITY, FNA", "ORAL, FNA", "FEMORAL HEAD, OTHER THAN FRACTURE", "HEART, PARTIAL RESECTION", "PLEURA, FNA", "VULVA, VULVECTOMY", "TRACHEA, BIOPSY", "BURN", "BRAIN, CYST", "CYST, FNA", "APPENDIX", "BONE, FNA", "AXILLA, FNA", "PENIS, PARTIAL RESECTION", "SPLEEN, BIOPSY", "URETER, BIOPSY", "SINUS, POLYP", "OVARY, CYST", "PAROTID GLAND, FNA", "BREAST, FNA", "AMNIOCENTESIS", "QUINTON CATHETER", "LIP, BIOPSY", "RETROPERITONEUM, BIOPSY", "SWAN GANZ CATHETER", "SCAR, EXCISION", "PELVIC, WASH", "COLOSTOMY", "SINUS, PREAURICULAR", "MEDIA", "CAROTID ARTERY, PLAQUE", "BREAST, IMPLANT", "OROPHARYNX, BIOPSY", "ENDOMETRIUM, CURETTAGE", "VAGINA, BIOPSY", "CONJUNCTIVA, BIOPSY", "HIP, DISARTICULATION", "SHOULDER, DISARTICULATION", "URETHRA", "SUTURE", "SUBMANDIBULAR GLAND, EXCISION", "URETER, WASHING", "PANCREAS, RESECTION", "THYROID, LOBECTOMY", "DISCHARGE", "URETHRA, WASHING", "MUSCLE, BIOPSY", "RECTUM, FNA", "FIBROADIPOSE TISSUE", "PERITONEUM, BIOPSY", "TAPE (PARASITES)", "LIVER, TOTAL RESECTION", "JAW, ODONTOGENIC TUMOR", "GRANULOMA", "UMBILICAL CORD", "LYMPH NODE, SENTINEL", "PELVIC WALL, BIOPSY", "SYNOVIAL CYST", "VEIN, SEGMENT", "PLAQUE", "JAW, CYST", "PARANASAL, BIOPSY", "EPIDERMOID CYST", "URINE VB", "VAGINA/CERVIX/ENDOCERVIX ", "UTERUS, FIBROID (SEPARATE SURGICAL PROCEDURE)", "RECTAL ABSCESS", "BREAST, NIPPLE, BIOPSY", "PERIANAL, BIOPSY", "CARTILAGE", "EMBOLUS", "OMENTUM, RESECTION", "ESOPHAGUS, FNA ", "LIP, MUCOCELE", "BILE DUCT, FNA", "NIPPLE, DISCHARGE", "PLACENTA, TWIN OR MULTIPLE", "RETROPERITONEUM, FNA", "MEDIASTINUM, MASS RESECTION", "NERVE, BIOPSY", "BILE DUCT, BRUSHING", "FORESKIN", "HEMANGIOMA, SKIN", "CARPAL TUNNEL", "SEMEN", "SOFT TISSUE, THORACIC OUTLET", "INTRAVENOUS CATHETER", "TRACHEOSTOMY", "UVULA", "BILE DUCT, WASHING", "TONSIL, RESECTION", "PHARYNX, ASPIRATE", "SINUS, INFLAMMATORY POLYP", "STUMP", "BRUSHING, NOS", "SUBMANDIBULAR GLAND, BIOPSY", "ILEUM, BIOPSY", "EYE, FNA", "INTRODUCER", "DIGIT, SUPERNUMERARY", "GANGLION CYST", "VITREOUS BODY", "ARTERY, BIOPSY", "ENDOMETRIUM, POLYP", "STENT", "RECTUM, BIOPSY", "OVARY +/- TUBE", "PROSTATE, TRANSURETHRAL RESECTION", "BITE", "FOURCHETTE", "TESTIS, BIOPSY", "ANUS, BIOPSY", "MUCOCELE", "DURA/LEPTOMENINGES", "HICKMAN CATHETER", "OMENTUM, BIOPSY", "STYE", "GROSHONG CATHETER", "CERVIX, BIOPSY", "URETER, BRUSHING", "VAGINA, RESECTION", "THYROID, THYROIDECTOMY", "VAGINA/ENDOCERVIX", "DIAPHRAGM", "ENDOMETRIUM, BIOPSY", "EPIDIDYMAL CYST", "SUBMANDIBULAR GLAND, FNA", "JOINT, CARTILAGE, SHAVING", "BALLOON TIP", "PLATELET CONCENTRATE", "CLITORIS", "SMALL INTESTINE, BIOPSY", "SKIN, NEVUS", "HYDROCELE", "FALLOPIAN TUBE, BIOPSY", "BROVIAC CATHETER", "PRE-PLANTED MEDIA", "THYROID, BIOPSY", "STOMACH, FNA", "SKIN, WART", "TESTIS, APPENDAGE", "COLON, MARGIN", "MIDDLE EAR FLUID", "EXPRESSED PROSTATIC SECRETIONS", "DUODENUM, BRUSHING", "ANUS, HEMORRHOIDS", "JEJUNUM, BIOPSY", "COLON WITH TERMINAL ILEIUM", "SINUS, CAVERNOUS"].sort

  belongs_to :patient
  belongs_to :line_item, optional: true #This association is for releasing a speciment to a line item
  belongs_to :recipient, class_name: "SPARC::Identity", optional: true 
  has_many :populations, through: :patient
  has_many :line_items, -> (lab) { where(service_source: lab.specimen_source) }, through: :populations #This association is for matching specimen sources between labs and line items

  delegate :mrn, to: :patient
  delegate :sparc_requests, to: :patient

  scope :usable, -> {
    where(status: [I18n.t(:labs)[:statuses][:available], I18n.t(:labs)[:statuses][:released]]) 
  }

  scope :search, -> (term) {
    return if term.blank?

    labs = joins(:patient).where(Patient.arel_table[:mrn].matches("%#{term}%"))
    request_labs = joins(patient: :sparc_requests).where(SparcRequest.arel_table[:protocol_id].matches(term))

    where(id: labs + request_labs)
  }
end
